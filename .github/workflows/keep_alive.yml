name: Wake Streamlit App
on:
  schedule:
    - cron: "0 */4 * * *" # Runs every 4 hours
  workflow_dispatch: # Allows manual trigger

jobs:
  wake_app:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Run Wake Script
        shell: python
        run: |
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.chrome.service import Service
          from webdriver_manager.chrome import ChromeDriverManager
          from selenium.webdriver.common.by import By
          import time

          # 1. Setup Chrome Options (Headless)
          options = Options()
          options.add_argument('--headless')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          options.add_argument('--disable-gpu')

          # 2. Initialize Driver
          service = Service(ChromeDriverManager().install())
          driver = webdriver.Chrome(service=service, options=options)

          print("Visiting app...")
          url = "https://aryanasignment-sayjr7rvushwkwhsewnoxx.streamlit.app"
          
          # Try to load the page (Retry logic)
          for attempt in range(3):
              try:
                  driver.get(url)
                  break
              except Exception as e:
                if attempt == 2:
                  raise
                print(f"Load failed ({attempt + 1}/3): {e}")
                time.sleep(5)
          
          time.sleep(5)
          print(f"Page Title: {driver.title}")

          # 3. Try to Click the 'Wake Up' Button if it exists
          try:
              buttons = driver.find_elements(By.TAG_NAME, "button")
              found = False
              for btn in buttons:
                  if "Yes, get this app back up!" in btn.text:
                      print("Found Wake Button. Clicking...")
                      btn.click()
                      time.sleep(10) # Wait for reload
                      print("Clicked!")
                      found = True
                      break
              if not found:
                  print("No wake button found (App might be already awake).")
          except Exception as e:
              print(f"Button check skipped: {e}")

          driver.quit()
          print("Done.")
